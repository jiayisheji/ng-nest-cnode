# Schematics 实战1

> 本篇使用 [Nx console](https://github.com/nrwl/nx-console) 插件完成。如果使用 `Schematics Cli` 或者 `Angular-cli` 可以参考我另外一篇[文章](https://github.com/jiayisheji/blog/issues/28)。

万丈高楼平地起，我们先写几个简单的例子练练手：

1. 动态创建一个`*.md`文件填入内容，并对它进行修改
2. 根据配置创建一个自定义模板文件
3. 根据配置创建一个自定义模板文件，修改原有的文件做关联
4. 迁移指定原有文件代码

> 我们需要一些工具函数 因为我们这是 `Angular` 扩展项目， 可以直接搬运 [https://github.com/angular/angular-cli/blob/master/packages/schematics/angular/utility](https://github.com/angular/angular-cli/blob/master/packages/schematics/angular/utility)。如果不是 `Angular` 也可以参考这些工具函数。

## 生成 md 文件

因为这是 `*.ts`，`schematics` 不能直接运行, 所以需要编译成 `*.js`

```bash
npx tsc -p ./schematics/tsconfig.json
```

在开一个命令行

```bash
npx schematics ./schematics/src/collection.json:hello-world
```

就会出现：

```text
? md文件使用什么名称? hello
CREATE hello.md (4 bytes)
```

> **注意**：现在只是一个虚拟的文件路径，并没有创建这个路径。默认创建是在项目根目录。默认：`--dry-run=true`，只会显示在命令行里

生成实际的文件：

```bash
npx schematics ./schematics/src/collection.json:hello-world --dry-run=false
```

我们已经生成文件，现在内容是写死的，再来一个输入属性，填充内容

```text
? md文件使用什么名称? world
? 请输入内容? hello
CREATE world.md (4 bytes)
```

你会发现我每次创建的名字都不一样，确实要这样，不然就会报错：`Error: Path "/hello.md" already exist.`。

那我们来实现修改功能

```text
? md文件使用什么名称? hello
? 请输入内容? 123456
UPDATE hello.md (18 bytes)
```

我们来实现删除文件，如果不输入内容就删除文件

```text
? md文件使用什么名称? hello
? 请输入内容?
? 请输入内容?
DELETE hello.md
```

我们已经实现一个md文件的新增、修改、删除功能。

接下来我们创建一个 `nx` 版的 `Schematics`

使用 `nx-console` 插件 选择 `Generate`

会出现项目可以使用的 `Schematics`，

我们选择： `@nrwl/workspace:workspace-schematic` 即可

然后输入 `name` 即可，

```text
CREATE tools/schematics/hello-world/index.ts (235 bytes)
CREATE tools/schematics/hello-world/schema.json (294 bytes)
```

> **注意**：一定要点右上角的 `Run` 按钮，不然不会生成实际的文件，还记得它吗：`--dry-run`。相当于先让我们确认生成的文件是否正确。

`nx` 版的 `Schematics` 和 `Schematics-cli` 版的 `Schematics` 有些不一样的，

1. 没有 `collection.json` 文件

`nx` 已经帮我们注册好了

2. `Schematics` 入口文件

现在是返回 `export default function() {}`

3. 运行 `Schematics` 方式

还记得我们怎么生成 `nx` 版的 `Schematics` 吗，对，如果我们要运行 `Schematics` 也需要使用 `nx-console` 插件 选择 `Generate` 然后 `workspace-schematic:hello-world` 即可

注意默认例子是生成一个 `nx-lib`，我们改成我们上面的例子即可。

> **注意**：改完 `schema.json` 一定要记得重启 `vscode` 不然还是之前的 `schema.json` 参数

我们来看效果，还是以 `hello.md` 为例：

`nx-console` 是 `GUI` 不需要命令行操作，完全傻瓜式的点选操作

新建：

```text
Executing task: nx workspace-schematic hello-world --name=hello --content=哈哈 --no-interactive --dry-run <

>  NX  Executing your local schematic: hello-world

CREATE hello.md (6 bytes)
```

修改：

```text
> Executing task: nx workspace-schematic hello-world --name=hello --content=哈哈2 <

>  NX  Executing your local schematic: hello-world

UPDATE hello.md (14 bytes)
```

删除：

```text
> Executing task: nx workspace-schematic hello-world --name=hello --content= <

>  NX  Executing your local schematic: hello-world

DELETE hello.md
```

> **注意**：在我们`GUI` 里面输入操作时，命令行会出现 `Error: Data path "" should have required property 'content'`，如果不想出现这个错误提示，只需要在 `schema.json` 里的`required` 去掉 `"content"` 即可。

这里不贴实际代码，代码比较简单，在源码里面也有注释，都是上篇我们讲解的基础 `API` 使用.

源码：

- [hello-world Schematics-cli 版](../../../schematics/src/hello-world)
- [hello-world Nx-cli 版](../../../tools/schematics/hello-world)

